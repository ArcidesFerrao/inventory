// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String        @id @default(uuid())
  name                String?
  email               String?       @unique
  emailVerified       DateTime?
  phoneNumber         String?       @unique
  phoneNumberVerified Boolean       @default(false)
  role                UserRole
  image               String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  hashedPassword      String?
  profileStatus       ProfileStatus @default(PENDING)

  Supplier     Supplier?
  Service      Service?
  AuditLog     AuditLog[]
  Notification Notification[]
}

model Item {
  id             String          @id @default(cuid())
  name           String
  description    String?
  unitQty        Int
  stock          Int?
  price          Float?
  critical       Int?            @default(0)
  status         ItemStatus      @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  categoryId     String?
  unitId         String?
  serviceId      String
  type           ItemType        @default(SERVICE)
  SaleItem       SaleItem[]
  PurchaseItem   PurchaseItem[]
  stockMovement  StockMovement[]
  CatalogItems   RecipeItem[]    @relation("CatalogItems")
  unit           Unit?           @relation(fields: [unitId], references: [id], onDelete: SetNull)
  category       Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  service        Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  deletedAt      DateTime?
  priceHistories PriceHistory[]

  @@index([deletedAt])
  @@index([serviceId, status])
}

model StockItem {
  id                String             @id @default(cuid())
  name              String
  description       String?
  unitQty           Int
  stock             Int?
  price             Float?
  cost              Float?
  supplierId        String
  unitId            String?
  categoryId        String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  status            ItemStatus         @default(ACTIVE)
  PurchaseItem      PurchaseItem[]
  OrderItem         OrderItem[]
  StockMovement     StockMovement[]
  SaleItem          SaleItem[]
  priceHistories    PriceHistory[]
  StockItems        RecipeItem[]       @relation("StockItems")
  unit              Unit?              @relation(fields: [unitId], references: [id], onDelete: SetNull)
  category          Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  supplier          Supplier           @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  serviceStockItems ServiceStockItem[]

  @@index([deletedAt])
  @@index([supplierId]) // list products per supplier
  @@index([status]) // filter by active/inactive
  @@index([name]) // search/autocomplete
  @@index([unitId])
}

model RecipeItem {
  id                 String           @id @default(cuid())
  quantity           Int
  itemId             String
  serviceStockItemId String
  catalogItem        Item             @relation("CatalogItems", fields: [itemId], references: [id], onDelete: Cascade)
  serviceStockItem   ServiceStockItem @relation("ServiceStockItems", fields: [serviceStockItemId], references: [id], onDelete: Cascade)
  stockItem          StockItem?       @relation("StockItems", fields: [stockItemId], references: [id])
  stockItemId        String?
  // serviceStockItem   ServiceStockItem @relation(fields: [serviceStockItemId], references: [id])

  @@index([itemId])
  @@index([serviceStockItemId])
}

model Supplier {
  id              String             @id @default(cuid())
  businessName    String // company name
  email           String?            @unique
  phoneNumber     String?            @unique
  address         String?
  businessReg     String?            @unique //Business registration number
  description     String?
  website         String?
  establishedYear Int? // activity year beginning
  specialization  String?
  badge           String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  userId          String             @unique
  user            User               @relation(fields: [userId], references: [id])
  StockItems      StockItem[]
  Customers       SupplierCustomer[]
  ActivityLog     ActivityLog[]

  Sale          Sale[]
  Category      Category[]
  orders        Order[]
  notifications Notification[]
}

model SupplierCustomer {
  id         String   @id @default(cuid())
  supplierId String
  serviceId  String
  createdAt  DateTime @default(now())
  Order      Order[]
  service    Service  @relation(fields: [serviceId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, serviceId])
}

model Service {
  id                String             @id @default(cuid())
  userId            String             @unique
  businessName      String
  phoneNumber       String             @unique
  location          String
  description       String?
  operationHours    String?
  website           String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  businessType      BusinessType
  items             Item[]
  serviceStockItems ServiceStockItem[]
  sales             Sale[]
  orders            Order[]
  purchases         Purchase[]
  Category          Category[]
  ActivityLog       ActivityLog[]
  supplierCustomers SupplierCustomer[]
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications     Notification[]

  @@unique([businessName, location])
}

model ServiceStockItem {
  id          String       @id @default(cuid())
  stock       Int?
  cost        Float?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  serviceId   String
  stockItemId String
  RecipeItems RecipeItem[] @relation("ServiceStockItems")
  status      ItemStatus   @default(ACTIVE)
  service     Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  stockItem   StockItem    @relation(fields: [stockItemId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]

  @@unique([serviceId, stockItemId])
  @@index([serviceId, status])
  @@index([stockItemId])
}

model Sale {
  id          String     @id @default(ulid())
  timestamp   DateTime   @default(now())
  total       Float
  cogs        Float      @default(0)
  paymentType String
  supplierId  String?
  serviceId   String?
  SaleItem    SaleItem[]
  Service     Service?   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  Supplier    Supplier?  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

model SaleItem {
  id          String     @id @default(ulid())
  saleId      String
  itemId      String?
  stockItemId String?
  quantity    Int
  price       Float
  item        Item?      @relation(fields: [itemId], references: [id], onDelete: SetNull)
  sale        Sale       @relation(fields: [saleId], references: [id], onDelete: Cascade)
  stockItem   StockItem? @relation(fields: [stockItemId], references: [id], onDelete: SetNull)
}

model Purchase {
  id           String         @id @default(ulid())
  timestamp    DateTime       @default(now())
  total        Float
  sourceType   String         @default("DIRECT") // "DIRECT" | "ORDER"
  paymentType  String
  sourceId     String?
  PurchaseItem PurchaseItem[]
  Service      Service?       @relation(fields: [serviceId], references: [id])
  serviceId    String?
}

model PurchaseItem {
  id          String     @id @default(ulid())
  itemId      String?
  purchaseId  String
  stockItemId String?
  stock       Int
  price       Float
  quantity    Int        @default(1)
  unitCost    Float      @default(0)
  totalCost   Float      @default(0)
  stockItem   StockItem? @relation(fields: [stockItemId], references: [id], onDelete: SetNull)
  purchase    Purchase   @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  item        Item?      @relation(fields: [itemId], references: [id], onDelete: SetNull)
}

model Order {
  id                 String            @id @default(ulid())
  timestamp          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  requestedStartDate DateTime
  requestedEndDate   DateTime
  notes              String?
  total              Float             @default(0)
  status             OrderStatus       @default(DRAFT)
  paymentType        String
  supplierCustomerId String?
  serviceId          String?
  supplierId         String
  supplier           Supplier          @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  delivery           Delivery?
  supplierCustomer   SupplierCustomer? @relation(fields: [supplierCustomerId], references: [id])
  Service            Service?          @relation(fields: [serviceId], references: [id])
  orderItems         OrderItem[]

  @@index([supplierCustomerId])
  @@index([supplierId, status])
  @@index([serviceId, timestamp])
}

model OrderItem {
  id                 String           @id @default(ulid())
  orderId            String
  stockItemId        String
  serviceStockItemId String
  orderedQty         Int
  deliveredQty       Int
  price              Float
  stockItem          StockItem        @relation(fields: [stockItemId], references: [id], onDelete: Restrict)
  serviceStockItem   ServiceStockItem @relation(fields: [serviceStockItemId], references: [id], onDelete: Restrict)
  order              Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  deliveries         DeliveryItem[]
}

model Delivery {
  id            String         @id @default(ulid())
  orderId       String         @unique
  scheduledAt   DateTime
  deliveredAt   DateTime?
  createdAt     DateTime       @default(now())
  notes         String?
  status        DeliveryStatus @default(PENDING)
  accepted      Boolean?
  reason        String?
  rating        Int?
  deliveryItems DeliveryItem[]
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([status])
}

model DeliveryItem {
  id          String    @id @default(ulid())
  deliveryId  String
  orderItemId String
  quantity    Int
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  delivery    Delivery  @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
}

model ActivityLog {
  id          String    @id @default(cuid())
  actionType  String
  entityType  String
  entityId    String?
  description String
  details     Json?
  ipAddress   String?
  device      String?
  severity    String    @default("INFO")
  timestamp   DateTime  @default(now())
  supplierId  String?
  serviceId   String?
  Service     Service?  @relation(fields: [serviceId], references: [id])
  Supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@index([entityType, entityId])
  @@index([timestamp])
}

model StockMovement {
  id          String      @id @default(cuid())
  itemId      String?
  stockItemId String?
  changeType  StockChange
  quantity    Int
  referenceId String?
  notes       String?
  timestamp   DateTime    @default(now())
  item        Item?       @relation(fields: [itemId], references: [id], onDelete: SetNull)
  stockItem   StockItem?  @relation(fields: [stockItemId], references: [id], onDelete: SetNull)
}

model PriceHistory {
  id          String   @id @default(cuid())
  itemId      String?
  stockItemId String?
  oldPrice    Float
  newPrice    Float
  timestamp   DateTime @default(now())
  reason      String?

  item      Item?      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  stockItem StockItem? @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  @@index([itemId, timestamp])
  @@index([stockItemId, timestamp])
}

model Category {
  id   String       @id @default(ulid())
  name String       @unique
  type CategoryType

  description String?

  supplierId String?
  serviceId  String?

  supplier  Supplier?   @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  service   Service?    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  Item      Item[]
  StockItem StockItem[]
  createdAt DateTime    @default(now())
}

model Unit {
  id          String      @id @default(ulid())
  name        String      @unique
  description String?
  items       Item[]
  stockItems  StockItem[]
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     String?
  action     String
  entityType String
  entityId   String
  entityName String
  details    Json?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

model Notification {
  id         String   @id @default(uuid())
  userId     String
  supplierId String?
  serviceId  String?
  type       String
  title      String
  message    String
  link       String?
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id])
  service  Service?  @relation(fields: [serviceId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])
}

enum StockChange {
  PURCHASE
  SALE
  WASTE
  ADJUSTMENT
  RECONCILIATION
}

enum ProfileStatus {
  PENDING
  SUSPENDED
  ACTIVE
  VERIFIED
  PRO
  ELITE
}

enum ItemStatus {
  ACTIVE
  INACTIVE
}

enum ItemType {
  SERVICE
  STOCK
}

enum OrderStatus {
  DRAFT // not submitted yet
  SUBMITTED // sent to supplier(s)
  CONFIRMED // supplier approved
  IN_PREPARATION // being prepared
  IN_DELIVERY // out for delivery
  DELIVERED // completed successfully
  CANCELLED // cancelled at any stage
}

enum DeliveryStatus {
  PENDING // waiting to be picked up
  IN_TRANSIT // being transported
  ARRIVED // reached destination
  COMPLETED // confirmed delivery received
  FAILED // failed delivery (e.g., not received)
  CANCELLED // cancelled delivery
}

enum PaymentType {
  CASH
  CREDIT
  DEBIT
  MOBILE_MONEY
}

enum UserRole {
  SERVICE
  SUPPLIER
  MANAGER
  ADMIN
}

enum BusinessType {
  RESTAURANT
  SHOP
  STORE
  MINIMARKET
  SUPERMARKET
  RETAIL
  RESELLER
}

enum CategoryType {
  SUPPLIER
  SERVICE
}
